<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•åŸ·è¡Œå¤§è¡¨ 2026 - å°ˆæ¥­ç©©å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f1f5f9; font-size: 13px; }
        .rundown-table, .item-table { width: 100%; border-collapse: collapse; border: 2px solid black; background: white; }
        .rundown-table th, .rundown-table td, .item-table th, .item-table td { border: 1.2px solid black; padding: 6px; vertical-align: top; position: relative; }
        .bg-gray-header { background-color: #f8fafc; }
        .input-line { border: none; border-bottom: 1px solid #94a3b8; outline: none; background: transparent; }
        .auto-height-cell { min-height: 40px; white-space: pre-wrap; word-break: break-all; outline: none; }
        .select-container { display: flex; flex-direction: column; gap: 2px; }
        select { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 2px; font-size: 11px; width: 100%; }
        
        /* ç‡ˆè™Ÿæ¨£å¼ */
        #syncStatus { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .status-offline { background-color: #ef4444; }
        .status-syncing { background-color: #f59e0b; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        @media print { .no-print { display: none !important; } body { background: white; padding: 0; } }
    </style>
</head>
<body class="p-4">

    <div id="capture-area" class="max-w-[1400px] mx-auto">
        <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex flex-wrap justify-between items-center border-t-4 border-blue-600">
            <div class="flex gap-4 items-center">
                <span class="font-black text-lg">2026 æ´»å‹•åŸ·è¡Œå¤§è¡¨</span>
                <div class="text-xs text-gray-500 flex items-center">
                    <span id="syncStatus" class="status-offline"></span>
                    <span id="syncText">æœ¬åœ°å­˜æª”ä¸­</span>
                </div>
            </div>
            <div class="flex gap-2 no-print">
                <button onclick="manualSync()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs font-bold hover:bg-blue-700 shadow">ğŸ’¾ ç«‹å³åŒæ­¥é›²ç«¯</button>
                <button onclick="exportToPDF()" class="bg-amber-500 text-white px-4 py-1.5 rounded text-xs font-bold hover:bg-amber-600 shadow">ğŸ“„ åŒ¯å‡º PDF</button>
            </div>
        </div>

        <div class="bg-white p-4 rounded shadow mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 font-bold items-center">
            <div>æ´»å‹•ä¸»é¡Œï¼š<input type="text" id="eventTitle" class="input-line w-2/3" value="æ–°æ´»å‹•å°ˆæ¡ˆ"></div>
            <div>åŸ·è¡Œæ—¥æœŸï¼š<input type="date" id="eventDate" class="input-line" onchange="updateDayOfWeek()"> <span id="dayOfWeek" class="text-blue-600"></span></div>
            <div>ç¸½å¬/ä¸»æŒï¼š
                <select id="headerHost" class="input-line w-1/2" onchange="syncHostName()">
                    <option value="Yin">Yin</option><option value="å°å·«">å°å·«</option><option value="Peter">Peter</option>
                </select>
            </div>
        </div>

        <div class="overflow-x-auto mb-6">
            <table id="rundownTable" class="rundown-table">
                <thead>
                    <tr class="bg-gray-header text-xs text-center">
                        <th style="width:100px">æ™‚é–“</th><th style="width:60px">é•·åº¦</th><th>å–®å…ƒå…§å®¹</th><th>åŸ·è¡Œç´°ç¯€ / å‚™è¨»</th><th style="width:100px">åˆ†å·¥</th><th style="width:100px">äººå“¡</th>
                    </tr>
                </thead>
                <tbody id="rundownBody"></tbody>
            </table>
            <button onclick="addRow()" class="mt-2 bg-slate-700 text-white px-4 py-1 rounded text-xs no-print hover:bg-black">+ æ–°å¢æµç¨‹é …ç›®</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 shadow border rounded">
                <h3 class="font-black border-b mb-3">æœå‹™å° / è¡Œæ”¿å™¨æ</h3>
                <div id="serviceDeskItems"></div>
                <button onclick="addManualItem('serviceDeskItems')" class="text-blue-500 text-xs mt-2 no-print">+ è‡ªå®šç¾©é …ç›®</button>
            </div>
            <div class="bg-white p-4 shadow border rounded">
                <h3 class="font-black border-b mb-3">èˆå° / è²å…‰å™¨æ</h3>
                <div id="stageItems"></div>
                <button onclick="addManualItem('stageItems')" class="text-blue-500 text-xs mt-2 no-print">+ è‡ªå®šç¾©é …ç›®</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbYj_gQTwKdVBCtOz2YP-zpAZw0arGDV4qksTY1_90lraOqdIPgvNOtcHaoGcp6E7Q3/exec";
        const staffs = ["éµä»", "æŸç·¯", "æ±Ÿå“¥", "ç‘©é©Š", "éœ²æ¯”", "èŠ³ç‘œ", "å´§ç‘‹", "å·¥è®€1", "å·¥è®€2"];
        const jobs = ["æ§å ´", "éŸ³éŸ¿", "ä¸»æŒäºº", "émic", "ä¸Šæ‰‹æ¿", "ä¸Šé“å…·", "æ”å½±", "å ±åˆ°å€"];
        let jobMapping = {};

        // 1. åˆå§‹åŒ–ï¼šæœ¬åœ°å„ªå…ˆ
        window.onload = () => {
            const localData = localStorage.getItem('rundown_cache');
            if (localData) {
                console.log("æ­£åœ¨åŠ è¼‰æœ¬åœ°å¿«å–...");
                renderPage(JSON.parse(localData));
            } else {
                initDefault();
            }
            // èƒŒæ™¯åŒæ­¥ï¼šæ‚„æ‚„å»æŠ“é›²ç«¯
            silentLoadFromCloud();
        };

        // èƒŒæ™¯éœé»˜åŠ è¼‰
        function silentLoadFromCloud() {
            setSyncStatus('syncing', 'æ­£åœ¨æ¯”å°é›²ç«¯...');
            const script = document.createElement('script');
            script.src = `${GAS_URL}?callback=handleBackgroundLoad&t=${Date.now()}`;
            script.onerror = () => setSyncStatus('offline', 'é›¢ç·šç·¨è¼¯æ¨¡å¼');
            document.body.appendChild(script);
        }

        window.handleBackgroundLoad = function(data) {
            if (data && data.rundown && data.rundown.length > 0) {
                // å¦‚æœé›²ç«¯æœ‰æ–°æ±è¥¿ï¼Œè©¢å•æ˜¯å¦è¦†è“‹
                const cloudTime = data.timestamp || 0;
                const localTime = parseInt(localStorage.getItem('rundown_ts') || 0);
                
                if (cloudTime > localTime) {
                    if (confirm("åµæ¸¬åˆ°æ‰‹æ©Ÿç«¯æœ‰æ›´æ–°çš„è³‡æ–™ï¼Œæ˜¯å¦è¼‰å…¥ï¼Ÿ")) {
                        renderPage(data);
                        saveToLocal(data);
                    }
                }
                setSyncStatus('online', 'é›²ç«¯å·²åŒæ­¥');
            } else {
                setSyncStatus('online', 'é›²ç«¯å°šç„¡è³‡æ–™');
            }
        };

        // ç«‹å³åŒæ­¥
        function manualSync() {
            setSyncStatus('syncing', 'æ­£åœ¨å‚³é€åˆ°é›²ç«¯...');
            const data = collectFormData();
            data.timestamp = Date.now();
            saveToLocal(data);

            const script = document.createElement('script');
            script.src = `${GAS_URL}?callback=handleSyncResponse&data=${encodeURIComponent(JSON.stringify(data))}`;
            document.body.appendChild(script);
        }

        window.handleSyncResponse = function(resp) {
            if (resp.result === "success") {
                setSyncStatus('online', 'åŒæ­¥æˆåŠŸï¼');
                alert("âœ… é›²ç«¯å­˜æª”æˆåŠŸ");
            }
        };

        function setSyncStatus(type, text) {
            const dot = document.getElementById('syncStatus');
            const txt = document.getElementById('syncText');
            dot.className = '';
            dot.classList.add('status-' + type);
            txt.innerText = text;
        }

        function saveToLocal(data) {
            localStorage.setItem('rundown_cache', JSON.stringify(data));
            localStorage.setItem('rundown_ts', Date.now());
        }

        function collectFormData() {
            const data = {
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                host: document.getElementById('headerHost').value,
                jobMapping: jobMapping,
                rundown: [],
                serviceItems: Array.from(document.querySelectorAll('#serviceDeskItems .checkbox-item')).map(el => ({n: el.querySelector('span[contenteditable]').innerText, checked: el.querySelector('input').checked, q: el.querySelector('.num-input').value})),
                stageItems: Array.from(document.querySelectorAll('#stageItems .checkbox-item')).map(el => ({n: el.querySelector('span[contenteditable]').innerText, checked: el.querySelector('input').checked, q: el.querySelector('.num-input').value}))
            };
            document.querySelectorAll("#rundownBody tr").forEach(row => {
                data.rundown.push({
                    startTime: row.querySelector(".start-time")?.value || "",
                    duration: row.querySelector(".duration").value,
                    unit: row.querySelector(".col-unit div").innerText,
                    desc: row.querySelector(".col-desc div").innerText,
                    jobs: Array.from(row.querySelectorAll(".job-s")).map(s => s.value),
                    staffs: Array.from(row.querySelectorAll(".staff-s")).map(s => s.value)
                });
            });
            return data;
        }

        // --- ä»¥ä¸‹ç‚º UI æ¸²æŸ“èˆ‡é€£å‹•é‚è¼¯ (èˆ‡æ‚¨æœ€ç¿’æ…£çš„ç‰ˆæœ¬ä¸€è‡´) ---
        function renderPage(data) {
            document.getElementById('eventTitle').value = data.title || "";
            document.getElementById('eventDate').value = data.date || "";
            document.getElementById('headerHost').value = data.host || "Yin";
            jobMapping = data.jobMapping || {};
            const tbody = document.getElementById("rundownBody");
            tbody.innerHTML = "";
            (data.rundown || []).forEach((item, idx) => addRow(idx === 0, item));
            renderList('serviceDeskItems', data.serviceItems);
            renderList('stageItems', data.stageItems);
            calculateAllTimes();
            updateDayOfWeek();
        }

        function addRow(isFirst = false, saved = null) {
            const tbody = document.getElementById("rundownBody");
            const tr = document.createElement("tr");
            let jobHTML = `<div class="select-container">`, staffHTML = `<div class="select-container">`;
            for(let i=0; i<5; i++) {
                let jV = saved?.jobs[i] || ""; let sV = saved?.staffs[i] || "";
                jobHTML += `<select class="job-s no-print" onchange="handleJobChange(this, ${i})"><option value="">-</option>${jobs.map(j=>`<option value="${j}" ${j===jV?'selected':''}>${j}</option>`).join('')}<option value="manual">æ‰‹å‹•</option></select>`;
                staffHTML += `<select class="staff-s no-print" onchange="handleStaffChange(this, ${i})"><option value="">-</option>${staffs.map(s=>`<option value="${s}" ${s===sV?'selected':''}>${s}</option>`).join('')}<option value="manual">æ‰‹å‹•</option></select>`;
            }
            tr.innerHTML = `<td class="text-center">${isFirst ? `<input type="time" class="start-time font-bold w-full text-center" value="${saved?.startTime||'09:00'}" oninput="calculateAllTimes()">` : '<span class="time-display"></span>'}</td>
                <td><input type="number" class="duration text-center w-full" value="${saved?.duration||10}" oninput="calculateAllTimes()"></td>
                <td class="col-unit"><div contenteditable="true" class="auto-height-cell font-bold text-blue-800">${saved?.unit||''}</div></td>
                <td class="col-desc"><div contenteditable="true" class="auto-height-cell text-gray-600">${saved?.desc||''}</div></td>
                <td>${jobHTML}</div></td><td>${staffHTML}</div></td>`;
            tbody.appendChild(tr);
            initSelectVisibility(tr);
        }

        function initDefault() {
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
            const tbody = document.getElementById("rundownBody");
            tbody.innerHTML = "";
            for (let i = 0; i < 7; i++) addRow(i === 0);
            renderList('serviceDeskItems', [{n:"ç°½åˆ°è¡¨", q:2}, {n:"é¤ç›’", q:0}]);
            renderList('stageItems', [{n:"éº¥å…‹é¢¨", q:4}]);
            calculateAllTimes();
            updateDayOfWeek();
        }

        function handleJobChange(select, index) {
            const row = select.closest("tr");
            const staffSelect = row.querySelectorAll(".staff-s")[index];
            if (select.value === "ä¸»æŒäºº") {
                staffSelect.value = document.getElementById("headerHost").value;
            } else if (select.value && jobMapping[select.value]) {
                staffSelect.value = jobMapping[select.value];
            }
            initSelectVisibility(row);
        }

        function handleStaffChange(select, index) {
            const row = select.closest("tr");
            const job = row.querySelectorAll(".job-s")[index].value;
            if (job && job !== "manual" && select.value) jobMapping[job] = select.value;
        }

        function initSelectVisibility(row) {
            const js = row.querySelectorAll('.job-s'), ss = row.querySelectorAll('.staff-s');
            js.forEach((s, i) => { if (i > 0) s.style.display = (js[i-1].value !== "") ? 'block' : 'none'; });
            ss.forEach((s, i) => { if (i > 0) s.style.display = (ss[i-1].value !== "") ? 'block' : 'none'; });
        }

        function calculateAllTimes() {
            const rows = document.querySelectorAll("#rundownBody tr");
            let next = "";
            rows.forEach((row, i) => {
                const dur = parseInt(row.querySelector(".duration").value) || 0;
                let start = (i === 0) ? row.querySelector(".start-time").value : next;
                if (start) {
                    let [h, m] = start.split(":").map(Number);
                    let em = m + dur; let eh = (h + Math.floor(em/60)) % 24; em %= 60;
                    let end = `${String(eh).padStart(2,'0')}:${String(em).padStart(2,'0')}`;
                    if (i !== 0) row.querySelector(".time-display").innerText = `${start}-${end}`;
                    next = end;
                }
            });
        }

        function renderList(id, items) {
            document.getElementById(id).innerHTML = (items||[]).map(i => `<div class="checkbox-item py-1 flex items-center gap-2 border-b border-gray-100"><input type="checkbox" ${i.checked?'checked':''}> <span contenteditable="true" class="flex-1">${i.n}</span> <input type="number" class="num-input w-10 text-center" value="${i.q||''}"></div>`).join('');
        }
        function addManualItem(id) { const div = document.createElement('div'); div.className = 'checkbox-item py-1 flex items-center gap-2 border-b border-gray-100'; div.innerHTML = `<input type="checkbox"> <span contenteditable="true" class="flex-1">æ–°é …ç›®</span> <input type="number" class="num-input w-10 text-center">`; document.getElementById(id).appendChild(div); }
        function updateDayOfWeek() { const d = new Date(document.getElementById('eventDate').value); if(!isNaN(d.getTime())) document.getElementById('dayOfWeek').innerText = `(é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`; }
        function syncHostName() { /* åŒæ­¥é€»è¾‘ */ }
        function exportToPDF() { const element = document.getElementById('capture-area'); html2pdf().set({ margin: 5, filename: 'Rundown.pdf', jsPDF: { format: 'a3', orientation: 'landscape' } }).from(element).save(); }
    </script>
</body>
</html>
