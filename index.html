<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 æ´»å‹•åŸ·è¡Œ - Firebase å½ˆæ€§é€£å‹•ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f1f5f9; font-size: 13px; }
        .rundown-table { width: 100%; border-collapse: collapse; border: 2px solid black; background: white; }
        .rundown-table th, .rundown-table td { border: 1.2px solid black; padding: 6px; vertical-align: top; }
        .input-line { border: none; border-bottom: 1px solid #94a3b8; outline: none; background: transparent; }
        .equipment-tag { display: inline-flex; align-items: center; background: white; border: 1px solid #cbd5e1; padding: 4px 8px; border-radius: 4px; margin: 4px; font-size: 12px; gap: 6px; }
        .btn-pick { background: #e2e8f0; padding: 2px 8px; border-radius: 99px; font-size: 11px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .btn-pick:hover { background: #cbd5e1; border-color: #64748b; }
        .num-input { width: 60px; border-bottom: 1px solid black; text-align: center; font-weight: bold; background: transparent; }
        select { cursor: pointer; background: #f8fafc; border-radius: 2px; }
        @media print { .no-print { display: none !important; } .equipment-tag { border: 1px solid black; } }
    </style>
</head>
<body class="p-4">

    <div id="capture-area" class="max-w-[1580px] mx-auto">
        <div class="bg-white p-4 rounded-lg shadow-md mb-4 border-t-4 border-orange-500">
            <div class="flex justify-between items-center mb-4">
                <span class="font-black text-xl text-orange-600">ğŸ”¥ Firebase å³æ™‚æ§åˆ¶å°</span>
                <div class="no-print flex gap-2">
                    <button onclick="saveToFirebase()" class="bg-orange-600 text-white px-5 py-2 rounded text-xs font-bold shadow-lg hover:bg-orange-700">ğŸ’¾ å„²å­˜ä¸¦ç™¼ä½ˆ</button>
                    <button onclick="exportToPDF()" class="bg-slate-700 text-white px-4 py-2 rounded text-xs font-bold">ğŸ“„ åŒ¯å‡º PDF</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 font-bold border-b pb-4 mb-4">
                <div>ä¸»é¡Œï¼š<input type="text" id="eventTitle" class="input-line w-2/3"></div>
                <div>æ—¥æœŸï¼š<input type="date" id="eventDate" class="input-line" onchange="updateDayOfWeek()"> <span id="dayOfWeek" class="text-blue-600"></span></div>
                <div>ä¸»æŒäººï¼š
                    <select id="headerHost" class="input-line w-1/2" onchange="syncPersonnel()">
                        <option value="Yin">Yin</option><option value="å°å·«">å°å·«</option><option value="Peter">Peter</option>
                        <option value="manual">æ‰‹å‹•è¼¸å…¥...</option>
                    </select>
                </div>
            </div>

            <div class="bg-orange-50 p-3 rounded border border-orange-200">
                <p class="text-orange-800 mb-2 font-black underline">åŸ·è¡Œäººå“¡é è¨­é€£å‹•ï¼š</p>
                <div class="flex flex-wrap gap-6 items-center">
                    <div>é è¨­åˆ†å·¥ï¼š<input type="text" id="customJob" placeholder="ä¾‹å¦‚:éŸ³æ§" class="input-line w-24"></div>
                    <div>å°æ‡‰äººå“¡ï¼š<input type="text" id="customStaff" placeholder="æ±Ÿå“¥" class="input-line w-24" oninput="syncPersonnel()"></div>
                    <div class="text-[11px] text-gray-500 italic">â€» è¨­å®šå¾Œï¼Œä¸‹æ–¹è¡¨æ ¼é¸å–æ­¤åˆ†å·¥å°‡è‡ªå‹•å¸¶å…¥äººå“¡ï¼Œæ‚¨ä»å¯æ‰‹å‹•æ›´æ”¹æ¯ä¸€æ¬„ã€‚</div>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto mb-6">
            <table id="rundownTable" class="rundown-table">
                <thead class="bg-slate-800 text-white text-xs">
                    <tr><th style="width:100px">æ™‚é–“</th><th style="width:60px">é•·åº¦</th><th style="width:220px">å–®å…ƒå…§å®¹</th><th>åŸ·è¡Œèªªæ˜</th><th style="width:110px">åˆ†å·¥</th><th style="width:110px">äººå“¡</th></tr>
                </thead>
                <tbody id="rundownBody"></tbody>
            </table>
            <button onclick="addRow()" class="mt-2 bg-slate-700 text-white px-4 py-1 rounded text-xs no-print hover:bg-black">+ å¢åŠ æµç¨‹é …ç›®</button>
        </div>

        <div class="bg-white p-4 shadow-lg border rounded">
            <h3 class="font-black text-lg border-l-4 border-blue-600 pl-2 mb-4 text-blue-800">å™¨ææ¸…å–®æ ¸å°</h3>
            
            <div class="no-print mb-4 p-4 bg-slate-50 rounded border border-dashed border-slate-300">
                <div class="mb-3"><strong>ğŸ“ æœå‹™å°é¸å–®ï¼š</strong>
                    <div id="serviceMenu" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
                <div><strong>ğŸ“ èˆå°å€é¸å–®ï¼š</strong>
                    <div id="stageMenu" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <div class="border p-4 rounded bg-white">
                    <h4 class="font-bold text-blue-700 mb-3 border-b pb-1">æœå‹™å°ï¼š</h4>
                    <div id="serviceDeskContainer" class="flex flex-wrap items-start"></div>
                </div>
                <div class="border p-4 rounded bg-white">
                    <h4 class="font-bold text-red-700 mb-3 border-b pb-1">èˆå°å€ï¼š</h4>
                    <div id="stageContainer" class="flex flex-wrap items-start"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://rundown-worker-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dataRef = ref(db, 'rundown_v2026');

        // å™¨æé¸å–®å®šç¾©
        const menuItems = {
            service: ["é•·å®˜ç°½åˆ°è¡¨ä¸€å¼", "é•·å®˜å‹¾é¸è¡¨", "ç“¶æ°´*{æ‰‹å‹•è¼¸å…¥}", "é¤ç›’*{æ‰‹å‹•è¼¸å…¥}", "ç°½åˆ°ç®±*1å¼", "æ–°èè³‡æ–™*{æ‰‹å‹•è¼¸å…¥}", "é»ƒæ¡Œå·¾*{æ‰‹å‹•è¼¸å…¥}", "ç´…æ¡Œå·¾*{æ‰‹å‹•è¼¸å…¥}", "ä¼´æ‰‹ç¦®*{æ‰‹å‹•è¼¸å…¥}"],
            stage: ["éŸ³éŸ¿+é›»è…¦1å¼", "TRUSS*{æ‰‹å‹•è¼¸å…¥}", "æ–œæ’*{æ‰‹å‹•è¼¸å…¥}", "éµæ¿*{æ‰‹å‹•è¼¸å…¥}", "å¸†å¸ƒ+è±†æ‰£*ALL", "ç´…æ¡Œå·¾*3", "æ¿•ç´™å·¾*3", "è¡›ç”Ÿç´™*2", "æ‰‹æ¿*5", "çµ¦ä¸»æŒäººæ‰‹æ¿*1", "æ­²æœ«é›†ç« å¡ç™¼æ”¾ç‰Œ+æœ¨æ¶*1", "2æ–œæ’+2éµæ¿+å¸†å¸ƒ+è±†æ‰£*ALL", "ç´…æ¡Œå·¾*{æ‰‹å‹•è¼¸å…¥}", "æ‰‹æ¿*{æ‰‹å‹•è¼¸å…¥}", "æœ¨æ¶*{æ‰‹å‹•è¼¸å…¥}"]
        };

        const staffs = ["éµä»", "æŸç·¯", "æ±Ÿå“¥", "ç‘©é©Š", "éœ²æ¯”", "èŠ³ç‘œ", "å´§ç‘‹", "å·¥è®€1", "å·¥è®€2"];
        const jobs = ["æ§å ´", "éŸ³éŸ¿", "ä¸»æŒäºº", "émic", "ä¸Šæ‰‹æ¿", "ä¸Šé“å…·", "æ”å½±", "å ±åˆ°å€"];

        window.onload = () => {
            initMenu('serviceMenu', menuItems.service, 'serviceDeskContainer');
            initMenu('stageMenu', menuItems.stage, 'stageContainer');
        };

        function initMenu(menuId, list, containerId) {
            const menu = document.getElementById(menuId);
            list.forEach(item => {
                const btn = document.createElement('span');
                btn.className = 'btn-pick';
                btn.innerText = `+ ${item.split('*')[0]}`;
                btn.onclick = () => addEquipment(containerId, item);
                menu.appendChild(btn);
            });
        }

        // --- æ ¸å¿ƒé€£å‹•ä¸”ä¿ç•™æ‰‹å‹• ---
        window.syncPersonnel = function() {
            const targetJob = document.getElementById('customJob').value;
            const targetStaff = document.getElementById('customStaff').value;
            const host = document.getElementById('headerHost').value;

            document.querySelectorAll("#rundownBody tr").forEach(row => {
                const jobSel = row.querySelector(".job-s");
                const staffSel = row.querySelector(".staff-s");
                
                // åªæœ‰åœ¨é¸å–®å€¼ç¬¦åˆé è¨­æ™‚æ‰é€£å‹•ï¼Œè‹¥ä½¿ç”¨è€…æ‰‹å‹•é¸éå‰‡ä¸å¼·è¡Œè¦†è“‹ï¼ˆé™¤éæ˜¯å‰›åˆ‡æ›ï¼‰
                if(jobSel.value === "ä¸»æŒäºº") {
                    ensureOption(staffSel, host); staffSel.value = host;
                } else if(targetJob && jobSel.value === targetJob) {
                    ensureOption(staffSel, targetStaff); staffSel.value = targetStaff;
                }
            });
        };

        // --- å™¨æé‚è¼¯ ---
        window.addEquipment = function(containerId, template, savedQty = "") {
            const container = document.getElementById(containerId);
            const tag = document.createElement('div');
            tag.className = 'equipment-tag';
            let name = template.split('*')[0];
            let isManual = template.includes('{æ‰‹å‹•è¼¸å…¥}');
            let fixedQty = template.includes('*') && !isManual ? template.split('*')[1] : "";

            tag.innerHTML = `
                <input type="checkbox" class="no-print">
                <span class="font-bold">${name}</span>
                ${isManual ? `*<input type="text" class="num-input" value="${savedQty}" placeholder="...">` : (fixedQty ? `*${fixedQty}` : '')}
                <span class="no-print text-red-400 cursor-pointer ml-1 hover:text-red-700" onclick="this.parentElement.remove()">âœ•</span>
            `;
            container.appendChild(tag);
        };

        // --- Firebase åŒæ­¥ ---
        onValue(dataRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                document.getElementById('eventTitle').value = data.title || "";
                document.getElementById('eventDate').value = data.date || "";
                ensureOption(document.getElementById('headerHost'), data.host);
                document.getElementById('headerHost').value = data.host || "Yin";
                document.getElementById('customJob').value = data.customJob || "";
                document.getElementById('customStaff').value = data.customStaff || "";
                
                const tbody = document.getElementById("rundownBody");
                tbody.innerHTML = "";
                (data.rundown || []).forEach((item, idx) => addRow(idx === 0, item));

                document.getElementById('serviceDeskContainer').innerHTML = "";
                (data.serviceEquip || []).forEach(e => addEquipment('serviceDeskContainer', e.t, e.q));
                document.getElementById('stageContainer').innerHTML = "";
                (data.stageEquip || []).forEach(e => addEquipment('stageContainer', e.t, e.q));

                calculateAllTimes();
                updateDayOfWeek();
            } else {
                initDefault();
            }
        });

        window.saveToFirebase = function() {
            const data = {
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                host: document.getElementById('headerHost').value,
                customJob: document.getElementById('customJob').value,
                customStaff: document.getElementById('customStaff').value,
                rundown: [],
                serviceEquip: Array.from(document.querySelectorAll('#serviceDeskContainer .equipment-tag')).map(el => ({
                    t: el.querySelector('span').innerText + (el.querySelector('.num-input') ? "*{æ‰‹å‹•è¼¸å…¥}" : ""),
                    q: el.querySelector('.num-input')?.value || ""
                })),
                stageEquip: Array.from(document.querySelectorAll('#stageContainer .equipment-tag')).map(el => ({
                    t: el.querySelector('span').innerText + (el.querySelector('.num-input') ? "*{æ‰‹å‹•è¼¸å…¥}" : ""),
                    q: el.querySelector('.num-input')?.value || ""
                }))
            };

            document.querySelectorAll("#rundownBody tr").forEach(row => {
                data.rundown.push({
                    startTime: row.querySelector(".start-time")?.value || "",
                    duration: row.querySelector(".duration").value,
                    unit: row.querySelector(".unit-cell").innerText,
                    desc: row.querySelector(".desc-cell").innerText,
                    jobs: [row.querySelector(".job-s").value],
                    staffs: [row.querySelector(".staff-s").value]
                });
            });

            set(dataRef, data).then(() => alert("âœ… é›²ç«¯å³æ™‚åŒæ­¥å®Œæˆ"));
        };

        // --- ä»‹é¢è¼”åŠ© ---
        window.addRow = function(isFirst = false, saved = null) {
            const tbody = document.getElementById("rundownBody");
            const tr = document.createElement("tr");
            
            const jobVal = saved?.jobs?.[0] || "";
            const staffVal = saved?.staffs?.[0] || "";
            
            // å»ºç«‹é¸å–®æ™‚ï¼Œç¢ºä¿æ‰‹å‹•è¼¸å…¥éçš„å€¼ä¹Ÿæœƒé¡¯ç¤º
            let jobOptions = jobs.map(j => `<option value="${j}" ${jobVal===j?'selected':''}>${j}</option>`).join('');
            let staffOptions = staffs.map(s => `<option value="${s}" ${staffVal===s?'selected':''}>${s}</option>`).join('');

            tr.innerHTML = `
                <td>${isFirst ? `<input type="time" class="start-time w-full text-center font-bold" value="${saved?.startTime||'09:00'}" oninput="calculateAllTimes()">` : '<span class="time-display flex justify-center text-xs"></span>'}</td>
                <td><input type="number" class="duration w-full text-center" value="${saved?.duration||10}" oninput="calculateAllTimes()"></td>
                <td contenteditable="true" class="unit-cell font-bold text-blue-900">${saved?.unit||''}</td>
                <td contenteditable="true" class="desc-cell text-gray-600 text-xs">${saved?.desc||''}</td>
                <td>
                    <select class="job-s w-full no-print" onchange="handleManualOption(this); syncPersonnel();">
                        <option value="">-</option>
                        ${jobOptions}
                        <option value="manual" class="text-blue-600">æ‰‹å‹•è¼¸å…¥...</option>
                    </select>
                </td>
                <td>
                    <select class="staff-s w-full no-print" onchange="handleManualOption(this)">
                        <option value="">-</option>
                        ${staffOptions}
                        <option value="manual" class="text-blue-600">æ‰‹å‹•è¼¸å…¥...</option>
                    </select>
                </td>
                <td class="no-print border-none align-middle"><span class="text-gray-300 cursor-pointer hover:text-red-500" onclick="this.closest('tr').remove();calculateAllTimes();">âœ•</span></td>
            `;
            tbody.appendChild(tr);
            if(jobVal && !jobs.includes(jobVal)) ensureOption(tr.querySelector(".job-s"), jobVal);
            if(staffVal && !staffs.includes(staffVal)) ensureOption(tr.querySelector(".staff-s"), staffVal);
            calculateAllTimes();
        };

        window.handleManualOption = function(sel) {
            if (sel.value === "manual") {
                const val = prompt("è«‹è¼¸å…¥è‡ªå®šç¾©å…§å®¹ï¼š");
                if (val) {
                    ensureOption(sel, val);
                    sel.value = val;
                } else {
                    sel.value = "";
                }
            }
        };

        function ensureOption(sel, val) {
            if (!val) return;
            const exists = Array.from(sel.options).some(opt => opt.value === val);
            if (!exists) {
                const newOpt = new Option(val, val);
                sel.add(newOpt, sel.options.length - 1);
            }
        }

        window.calculateAllTimes = function() {
            const rows = document.querySelectorAll("#rundownBody tr");
            let next = "";
            rows.forEach((row, i) => {
                const dur = parseInt(row.querySelector(".duration").value) || 0;
                let start = (i === 0) ? row.querySelector(".start-time").value : next;
                if (start) {
                    let [h, m] = start.split(":").map(Number);
                    let em = m + dur; let eh = (h + Math.floor(em/60)) % 24; em %= 60;
                    let end = `${String(eh).padStart(2,'0')}:${String(em).padStart(2,'0')}`;
                    if (i !== 0) row.querySelector(".time-display").innerText = `${start}-${end}`;
                    next = end;
                }
            });
        };

        window.updateDayOfWeek = function() {
            const d = new Date(document.getElementById('eventDate').value);
            if(!isNaN(d.getTime())) document.getElementById('dayOfWeek').innerText = `(é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`;
        };

        function initDefault() {
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
            for (let i = 0; i < 5; i++) addRow(i === 0);
            updateDayOfWeek();
        }

        window.exportToPDF = function() {
            const element = document.getElementById('capture-area');
            html2pdf().set({ margin: 5, filename: 'Rundown_2026.pdf', jsPDF: { format: 'a3', orientation: 'landscape' } }).from(element).save();
        };
    </script>
</body>
</html>
