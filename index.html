<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•åŸ·è¡Œå¤§è¡¨ - å°ˆæ¥­åŸ·è¡Œç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f8fafc; font-size: 13px; }
        .rundown-table, .item-table { width: 100%; border-collapse: collapse; border: 2px solid black; background: white; table-layout: fixed; }
        .rundown-table th, .rundown-table td, .item-table th, .item-table td { border: 1.2px solid black; padding: 6px; vertical-align: top; }
        .bg-gray-header { background-color: #f3f4f6; }
        .input-line { border: none; border-bottom: 1px solid black; outline: none; background: transparent; }
        
        /* é¸å–®æ¨£å¼ï¼šä¿æŒåŸºæœ¬é«˜åº¦ï¼Œä½†ä¸å¼·åˆ¶æ’é–‹ 5 å€ */
        .select-container { min-height: 24px; display: flex; flex-direction: column; gap: 2px; }
        select { background: #f9fafb; outline: none; width: 100%; cursor: pointer; font-size: 11px; border: 1px solid #ddd; border-radius: 2px; }
        
        .col-time { width: 110px; }
        .col-len { width: 55px; }
        .col-job, .col-staff { width: 90px; }
        .col-op { width: 35px; }
        
        .time-display { font-family: 'Courier New', monospace; font-weight: bold; color: #1d4ed8; text-align: center; display: block; }
        .checkbox-item { display: block; padding: 2px 0; font-size: 12px; cursor: pointer; }
        .checkbox-item input { margin-right: 5px; }
    </style>
</head>
<body class="p-2">

    <div class="max-w-[1550px] mx-auto">
        <div class="bg-white p-4 rounded shadow border mb-3 flex flex-wrap gap-4 font-bold text-sm items-center">
            <div>ä¸»é¡Œï¼š<input type="text" class="input-line w-44" value="2026 è¨˜è€…æœƒ"></div>
            <div>æ—¥æœŸï¼š<input type="date" id="eventDate" class="input-line" onchange="updateDayOfWeek()"><span id="dayOfWeek" class="ml-1 text-blue-600"></span></div>
            <div>åœ°é»ï¼š<input type="text" class="input-line w-40"></div>
            <div>ä¸»æŒäººï¼š
                <select id="headerHost" class="input-line w-24 border-b border-black font-bold" onchange="syncHostName()">
                    <option value="Yin">Yin</option><option value="å°å·«">å°å·«</option><option value="Peter">Peter</option><option value="å°æŸ”">å°æŸ”</option><option value="manual">æ‰‹å‹•è¼¸å…¥...</option>
                </select>
            </div>
            <div class="flex-1 text-right flex justify-end gap-2">
                <button onclick="calculateAllTimes()" class="bg-amber-500 text-white px-3 py-1.5 rounded text-xs shadow hover:bg-amber-600 font-bold">ğŸ”„ å³æ™‚æ›´æ–°</button>
                <a href="https://script.google.com/macros/s/AKfycbyKe0EVXuPva48B_ocPMpJBRjG-kLbyhDf4eeofN5Mnq060Mb60OucBXtLRqxK2ON6w9Q/exec" target="_blank" class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs shadow hover:bg-blue-700">ğŸ™ï¸ é•·å®˜ç°½åˆ°æƒ…æ³</a>
            </div>
        </div>

        <div class="bg-white p-2 shadow-lg border mb-6">
            <div class="flex justify-between mb-2 px-1 text-xs">
                <span class="text-blue-600 font-bold">â€» æµç¨‹è¡¨ (å›ºå®š 7 è¡Œèµ·è·³)</span>
                <button onclick="addRow()" class="bg-green-600 text-white px-4 py-1 rounded font-bold hover:bg-green-700 shadow-md">+ å¢åŠ ä¸€è¡Œ</button>
            </div>
            <table id="rundownTable" class="rundown-table">
                <thead>
                    <tr class="bg-gray-header text-xs">
                        <th class="col-time">æ™‚é–“å€æ®µ</th>
                        <th class="col-len">é•·åº¦</th>
                        <th>å–®å…ƒé …ç›®</th>
                        <th class="col-job">åˆ†å·¥</th>
                        <th class="col-staff">äººå“¡</th>
                        <th>é‡é»å·¥ä½œå…§å®¹</th>
                        <th class="col-op">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="rundownBody">
                    </tbody>
            </table>
        </div>

        <div class="bg-white p-4 shadow-lg border">
            <div class="flex justify-between items-center mb-2 border-l-4 border-blue-600 pl-2">
                <h3 class="font-black text-lg">å™¨ææ¸…å–®æ ¸å°</h3>
                <button onclick="addListRow()" class="bg-gray-700 text-white px-4 py-1 rounded text-xs font-bold hover:bg-black">+ æ–°å¢å™¨æè¡Œ</button>
            </div>
            <table class="item-table text-xs">
                <thead>
                    <tr class="bg-gray-800 text-white">
                        <th class="w-1/3 py-2">æœå‹™å°</th>
                        <th class="w-1/3 py-2">èˆå°</th>
                        <th class="w-1/3 py-2">å‚™è¨» / è‡ªå®šç¾©</th>
                    </tr>
                </thead>
                <tbody id="itemListBody">
                    <tr>
                        <td id="serviceDeskItems"></td>
                        <td id="stageItems"></td>
                        <td contenteditable="true" class="text-gray-400 p-2">é»æ“Šè¼¸å…¥å…¶ä»–å‚™è¨»äº‹é …...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const staffs = ["éµä»", "æŸç·¯", "æ±Ÿå“¥", "ç‘©é©Š", "éœ²æ¯”", "èŠ³ç‘œ", "å´§ç‘‹", "å·¥è®€1", "å·¥è®€2"];
        const jobs = ["æ§å ´", "éŸ³éŸ¿", "ä¸»æŒäºº", "émic", "ä¸Šæ‰‹æ¿", "ä¸Šé“å…·"];
        const serviceItems = ["æœå‹™å°ç®±", "ç°½åˆ°è¡¨", "é•·å®˜è²´è³“åå–®", "æ¡Œå¸ƒ", "é¤ç›’*æ•¸é‡", "é•·æ¡Œ*æ•¸é‡", "æ–°èè³‡æ–™*æ•¸é‡", "ç“¶æ°´*æ•¸é‡", "ä¼´æ‰‹ç¦®*æ•¸é‡", "åŸºæœ¬è† å¸¶", "åŸºæœ¬å·¥å…·", "æ¨è»Š*æ•¸é‡"];
        const stageItems = ["truss æ•¸é‡xæ•¸é‡", "æ–œæ’*æ•¸é‡", "æ²™åŒ…*æ•¸é‡", "æ‰‹æ¿*æ•¸é‡", "å¸ƒä¸æ¤…*æ•¸é‡", "æŠ˜ç–Šæ¤…*æ•¸é‡", "éŸ³éŸ¿", "2æŠ•é¢å…‰*æ•¸é‡", "parç‡ˆ*æ•¸é‡"];

        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('eventDate').value = today;
            updateDayOfWeek();
            // å¼·åˆ¶åˆå§‹åŒ– 7 è¡Œ
            const tbody = document.getElementById("rundownBody");
            tbody.innerHTML = ""; 
            for (let i = 0; i < 7; i++) {
                addRow(i === 0);
            }
            renderChecklists();
            calculateAllTimes();
        };

        function updateDayOfWeek() {
            const dateVal = document.getElementById('eventDate').value;
            if (!dateVal) return;
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const d = new Date(dateVal);
            document.getElementById('dayOfWeek').innerText = `(é€±${days[d.getDay()]})`;
        }

        function renderChecklists() {
            document.getElementById('serviceDeskItems').innerHTML = serviceItems.map(item => `<label class="checkbox-item"><input type="checkbox"> å›— ${item}</label>`).join('');
            document.getElementById('stageItems').innerHTML = stageItems.map(item => `<label class="checkbox-item"><input type="checkbox"> å›— ${item}</label>`).join('') + `<label class="checkbox-item"><input type="checkbox" onchange="manualCheck(this)"> å›— æ‰‹å‹•è¼¸å…¥...</label>`;
        }

        function addRow(isFirst = false) {
            const tbody = document.getElementById("rundownBody");
            const tr = document.createElement("tr");
            
            const timeHTML = isFirst 
                ? `<div class="flex flex-col items-center"><input type="time" class="start-time text-xs font-bold w-full text-center" value="09:00" oninput="calculateAllTimes()"><span id="endTime0" class="text-[10px] text-blue-500 font-bold"></span></div>`
                : `<span class="time-display text-xs">--:--</span>`;

            // é¸å–® HTML çµæ§‹ï¼šåŒ…è£¹åœ¨å½ˆæ€§å®¹å™¨ä¸­
            let jobHTML = `<div class="select-container">`;
            let staffHTML = `<div class="select-container">`;
            for(let i=0; i<5; i++) {
                jobHTML += `<select class="job-s" onchange="handleJobChange(this)"><option value="">-</option>${jobs.map(j=>`<option value="${j}">${j}</option>`).join('')}<option value="manual">è‡ªå®šç¾©</option></select>`;
                staffHTML += `<select class="staff-s" onchange="checkManual(this)"><option value="">-</option>${staffs.map(s=>`<option value="${s}">${s}</option>`).join('')}<option value="manual">è‡ªå®šç¾©</option></select>`;
            }
            jobHTML += `</div>`; staffHTML += `</div>`;

            tr.innerHTML = `
                <td class="col-time text-center">${timeHTML}</td>
                <td class="col-len"><input type="number" class="duration text-center w-full text-xs font-bold" value="10" oninput="calculateAllTimes()"></td>
                <td contenteditable="true" class="font-bold px-2 text-blue-900">å–®å…ƒé …ç›®</td>
                <td class="col-job">${jobHTML}</td>
                <td class="col-staff">${staffHTML}</td>
                <td contenteditable="true" class="text-xs px-2 text-gray-500 italic">å·¥ä½œå…§å®¹...</td>
                <td class="col-op text-center"><button onclick="deleteRow(this)" class="text-red-400 hover:text-red-600 font-bold">âœ•</button></td>
            `;
            tbody.appendChild(tr);
            if(!isFirst) calculateAllTimes();
            initSelectVisibility(tr);
        }

        // å…§éƒ¨é¸å–®éš±è—é‚è¼¯ï¼šä¿æŒ Row é«˜åº¦ç©©å®šï¼Œä½†å…§éƒ¨é¸å–®æŒ‰éœ€å‡ºç¾
        function initSelectVisibility(row) {
            const jobSels = row.querySelectorAll('.job-s');
            const staffSels = row.querySelectorAll('.staff-s');
            const refresh = () => {
                jobSels.forEach((sel, i) => { if (i > 0) sel.style.display = (jobSels[i-1].value !== "") ? 'block' : 'none'; });
                staffSels.forEach((sel, i) => { if (i > 0) sel.style.display = (staffSels[i-1].value !== "") ? 'block' : 'none'; });
            };
            row.addEventListener('change', refresh);
            refresh();
        }

        function calculateAllTimes() {
            const rows = document.querySelectorAll("#rundownBody tr");
            let nextStart = "";
            rows.forEach((row, i) => {
                const duration = parseInt(row.querySelector(".duration").value) || 0;
                let startStr = (i === 0) ? row.querySelector(".start-time").value : nextStart;
                if (startStr) {
                    let [h, m] = startStr.split(":").map(Number);
                    let endM = m + duration;
                    let endH = (h + Math.floor(endM/60)) % 24;
                    endM %= 60;
                    const endStr = `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
                    if (i === 0) document.getElementById("endTime0").innerText = `${startStr}-${endStr}`;
                    else row.querySelector(".time-display").innerText = `${startStr}-${endStr}`;
                    nextStart = endStr;
                }
            });
        }

        function handleJobChange(select) {
            if (select.value === "ä¸»æŒäºº") {
                const row = select.closest("tr");
                const jobSels = Array.from(row.querySelectorAll('.job-s'));
                const index = jobSels.indexOf(select);
                const staffSelect = row.querySelectorAll(".staff-s")[index];
                staffSelect.value = document.getElementById("headerHost").value;
                staffSelect.dispatchEvent(new Event('change')); // è§¸ç™¼é¡¯ç¤º
            }
            checkManual(select);
        }

        function syncHostName() {
            document.querySelectorAll(".job-s").forEach((sel) => {
                if (sel.value === "ä¸»æŒäºº") {
                    const row = sel.closest("tr");
                    const idx = Array.from(row.querySelectorAll('.job-s')).indexOf(sel);
                    const staffSel = row.querySelectorAll(".staff-s")[idx];
                    staffSel.value = document.getElementById("headerHost").value;
                }
            });
            updateDayOfWeek();
        }

        function deleteRow(btn) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { btn.closest("tr").remove(); calculateAllTimes(); } }

        function addListRow() {
            const tbody = document.getElementById("itemListBody");
            const tr = document.createElement("tr");
            tr.innerHTML = `<td contenteditable="true" class="p-2 border"></td><td contenteditable="true" class="p-2 border"></td><td contenteditable="true" class="p-2 border"></td>`;
            tbody.appendChild(tr);
        }

        function checkManual(sel) {
            if (sel.value === "manual") {
                const v = prompt("è«‹è¼¸å…¥è‡ªå®šç¾©å…§å®¹ï¼š");
                if (v) { const opt = new Option(v, v); sel.add(opt, sel[0]); sel.value = v; sel.dispatchEvent(new Event('change'));
                } else { sel.selectedIndex = 0; }
            }
        }
        
        function manualCheck(input) {
            if (input.checked) {
                const v = prompt("è«‹è¼¸å…¥æ–°å¢å™¨æåç¨±ï¼š");
                if (v) { input.closest('label').innerHTML = `<input type="checkbox" checked> å›— ${v}`;
                } else { input.checked = false; }
            }
        }
    </script>
</body>
</html>
