<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•åŸ·è¡Œå¤§è¡¨ - 2026 é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f1f5f9; font-size: 13px; }
        .rundown-table, .item-table { width: 100%; border-collapse: collapse; border: 2px solid #000; background: white; }
        .rundown-table th, .rundown-table td { border: 1px solid #000; padding: 8px; vertical-align: top; position: relative; }
        .col-unit, .col-desc { width: 150px; }
        .auto-height-cell { min-height: 40px; white-space: pre-wrap; word-break: break-all; outline: none; }
        .del-btn { position: absolute; right: -25px; top: 10px; color: #ccc; cursor: pointer; font-weight: bold; }
        tr:hover .del-btn { color: #ef4444; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; justify-content: center; align-items: center; font-weight: bold; }
        @media print { .no-print { display: none !important; } body { padding: 0; } }
    </style>
</head>
<body class="p-4 pr-10">

    <div id="loading" class="loading-overlay">â³ é›²ç«¯åŒæ­¥ä¸­...</div>

    <div id="capture-area" class="max-w-[1580px] mx-auto">
        <div class="bg-white p-4 rounded shadow border mb-4 flex flex-wrap gap-4 font-bold items-center">
            <div>ä¸»é¡Œï¼š<input type="text" id="eventTitle" class="border-b border-black outline-none w-48"></div>
            <div>æ—¥æœŸï¼š<input type="date" id="eventDate" onchange="updateDayOfWeek()"> <span id="dayOfWeek" class="text-blue-600"></span></div>
            <div class="flex-1 text-right flex justify-end gap-2 no-print">
                <button onclick="syncToCloud()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 font-bold">â˜ï¸ å„²å­˜ä¸¦ç™¼ä½ˆè‡³é›²ç«¯</button>
                <button onclick="loadFromCloud()" class="bg-gray-500 text-white px-4 py-2 rounded shadow hover:bg-gray-600 font-bold">ğŸ”„ æ‰‹å‹•é‡æ–°æ•´ç†</button>
                <button onclick="exportToPDF()" class="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 font-bold">ğŸ“„ PDFåˆ†äº«</button>
            </div>
        </div>

        <table id="rundownTable" class="rundown-table mb-6">
            <thead class="bg-gray-100 text-xs">
                <tr>
                    <th width="100">æ™‚é–“</th><th width="60">é•·åº¦</th><th class="col-unit">å–®å…ƒ</th><th class="col-desc">å·¥ä½œèªªæ˜</th><th>åˆ†å·¥äººå“¡é€£å‹•</th>
                </tr>
            </thead>
            <tbody id="rundownBody"></tbody>
        </table>
        <button onclick="addRow()" class="no-print bg-green-600 text-white px-4 py-1 rounded mb-10">+ å¢åŠ æµç¨‹</button>
    </div>

    <script>
        const GAS_URL = "ä½ çš„_GOOGLE_APP_SCRIPT_ç¶²å€"; // <--- å‹™å¿…æ›¿æ›é€™è£¡
        const staffs = ["éµä»", "æŸç·¯", "æ±Ÿå“¥", "ç‘©é©Š", "éœ²æ¯”", "èŠ³ç‘œ", "å´§ç‘‹"];
        const jobs = ["æ§å ´", "éŸ³éŸ¿", "ä¸»æŒäºº", "émic", "ä¸Šæ‰‹æ¿", "æ”å½±"];
        let jobMapping = {};

        window.onload = () => {
            loadFromCloud(); // é–‹å•Ÿç¶²é è‡ªå‹•å¾é›²ç«¯æ‰å–æœ€æ–°è³‡æ–™
        };

        async function syncToCloud() {
            showLoading(true);
            calculateAllTimes();
            const data = {
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                rundown: []
            };
            document.querySelectorAll("#rundownBody tr").forEach(row => {
                data.rundown.push({
                    startTime: row.querySelector(".start-time")?.value || "",
                    duration: row.querySelector(".duration").value,
                    unit: row.querySelector(".col-unit div").innerText,
                    desc: row.querySelector(".col-desc div").innerText,
                    jobs: Array.from(row.querySelectorAll(".job-s")).map(s => s.value),
                    staffs: Array.from(row.querySelectorAll(".staff-s")).map(s => s.value)
                });
            });

            try {
                await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify(data)
                });
                alert("âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼å¦ä¸€æ”¯æ‰‹æ©Ÿé‡æ–°æ•´ç†å³å¯çœ‹åˆ°æ›´æ–°ã€‚");
            } catch (e) {
                alert("âŒ åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS éƒ¨ç½²è¨­å®šã€‚");
            }
            showLoading(false);
        }

        async function loadFromCloud() {
            showLoading(true);
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                if (data.rundown) {
                    document.getElementById('eventTitle').value = data.title;
                    document.getElementById('eventDate').value = data.date;
                    const tbody = document.getElementById("rundownBody");
                    tbody.innerHTML = "";
                    data.rundown.forEach((item, idx) => addRow(idx === 0, item));
                    updateDayOfWeek();
                    calculateAllTimes();
                }
            } catch (e) {
                console.log("å°šç„¡é›²ç«¯è³‡æ–™æˆ–è®€å–éŒ¯èª¤");
                // åˆå§‹ç©ºè¡¨æ ¼
                if(document.getElementById("rundownBody").innerHTML === "") addRow(true);
            }
            showLoading(false);
        }

        function addRow(isFirst = false, saved = null) {
            const tbody = document.getElementById("rundownBody");
            const tr = document.createElement("tr");
            let selects = "";
            for(let i=0; i<3; i++) { // ç°¡åŒ–ç‚º3çµ„ä»¥åˆ©æ‰‹æ©Ÿé–±è®€
                let jV = saved?.jobs[i] || "";
                let sV = saved?.staffs[i] || "";
                selects += `
                <div class="flex gap-1 mb-1">
                    <select class="job-s flex-1" onchange="handleJobChange(this, ${i})"><option value="">-</option>${jobs.map(j=>`<option value="${j}" ${j===jV?'selected':''}>${j}</option>`).join('')}</select>
                    <select class="staff-s flex-1" onchange="handleStaffChange(this, ${i})"><option value="">-</option>${staffs.map(s=>`<option value="${s}" ${s===sV?'selected':''}>${s}</option>`).join('')}</select>
                </div>`;
            }
            tr.innerHTML = `
                <td>${isFirst ? `<input type="time" class="start-time w-full font-bold" value="${saved?.startTime||'09:00'}" oninput="calculateAllTimes()">` : '<span class="time-display"></span>'}</td>
                <td><input type="number" class="duration w-full text-center font-bold" value="${saved?.duration||10}" oninput="calculateAllTimes()"></td>
                <td class="col-unit"><div contenteditable="true" class="auto-height-cell font-bold text-blue-800">${saved?.unit||'å–®å…ƒ'}</div></td>
                <td class="col-desc"><div contenteditable="true" class="auto-height-cell text-gray-600">${saved?.desc||'å·¥ä½œèªªæ˜'}</div></td>
                <td>${selects}</td>
                <span class="del-btn no-print" onclick="this.closest('tr').remove();calculateAllTimes();">âœ•</span>`;
            tbody.appendChild(tr);
        }

        // ... å…¶é¤˜é‚è¼¯ï¼šæ™ºæ…§é€£å‹•ã€æ™‚é–“è¨ˆç®—ã€PDFåŒ¯å‡ºèˆ‡å…ˆå‰ä¸€è‡´ ...
        function calculateAllTimes() {
            const rows = document.querySelectorAll("#rundownBody tr");
            let next = "";
            rows.forEach((row, i) => {
                const dur = parseInt(row.querySelector(".duration").value) || 0;
                let start = (i === 0) ? row.querySelector(".start-time").value : next;
                if (start) {
                    let [h, m] = start.split(":").map(Number);
                    let em = m + dur; let eh = (h + Math.floor(em/60))%24; em %= 60;
                    let end = `${String(eh).padStart(2,'0')}:${String(em).padStart(2,'0')}`;
                    if (i !== 0) row.querySelector(".time-display").innerText = `${start}-${end}`;
                    next = end;
                }
            });
        }
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
        function updateDayOfWeek() { const d = new Date(document.getElementById('eventDate').value); if(!isNaN(d.getTime())) document.getElementById('dayOfWeek').innerText = `(é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`; }
    </script>
</body>
</html>
