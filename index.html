<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•åŸ·è¡Œå¤§è¡¨ - 2026 å°ˆæ¥­æ™ºèƒ½å„²å­˜ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f8fafc; font-size: 13px; }
        .rundown-table, .item-table { width: 100%; border-collapse: collapse; border: 2px solid black; background: white; }
        .rundown-table th, .rundown-table td, .item-table th, .item-table td { border: 1.2px solid black; padding: 6px; vertical-align: top; position: relative; }
        .bg-gray-header { background-color: #f3f4f6; }
        .input-line { border: none; border-bottom: 1px solid black; outline: none; background: transparent; }
        .auto-height-cell { min-height: 40px; white-space: pre-wrap; word-break: break-all; outline: none; }
        .select-container { display: flex; flex-direction: column; gap: 2px; }
        select { background: #f9fafb; outline: none; width: 100%; cursor: pointer; font-size: 11px; border: 1px solid #ddd; border-radius: 2px; }
        
        /* æ¬„å¯¬è¨­å®š */
        .col-time { width: 100px; text-align: center; }
        .col-len { width: 55px; text-align: center; }
        .col-unit { width: 150px; } 
        .col-desc { width: 150px; } 
        .col-job, .col-staff { width: 75px; }
        
        .del-btn { position: absolute; right: -25px; top: 15px; color: #ccc; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 16px; }
        tr:hover .del-btn { color: #ef4444; }
        
        .checkbox-item { display: flex; align-items: center; padding: 4px 8px; font-size: 12px; gap: 8px; background: white; border: 1px solid transparent; cursor: grab; }
        .checkbox-item:hover { background: #f1f5f9; border-color: #cbd5e1; border-radius: 4px; }
        .sortable-ghost { opacity: 0.4; background: #dbeafe; }
        
        .time-display { font-family: 'Courier New', monospace; font-weight: bold; color: #1d4ed8; text-align: center; display: block; }
        .num-input { width: 45px; border: 1px solid #ccc; border-radius: 3px; padding: 1px 2px; text-align: center; }
        .add-item-btn { font-size: 10px; color: #2563eb; cursor: pointer; text-decoration: underline; margin-top: 8px; display: block; padding-left: 8px; }

        @media print { .no-print { display: none !important; } .del-btn { display: none !important; } body { padding: 0; } }
    </style>
</head>
<body class="p-2 pr-10">

    <div id="capture-area" class="max-w-[1580px] mx-auto">
        <div class="bg-white p-4 rounded shadow border mb-3 flex flex-wrap gap-4 font-bold text-sm items-center">
            <div>ä¸»é¡Œï¼š<input type="text" id="eventTitle" class="input-line w-48" value=""></div>
            <div>æ—¥æœŸï¼š<input type="date" id="eventDate" class="input-line" onchange="updateDayOfWeek()"> <span id="dayOfWeek" class="text-blue-600"></span></div>
            <div>ä¸»æŒäººï¼š
                <select id="headerHost" class="input-line w-28 border-b border-black font-bold" onchange="syncHostName()">
                    <option value="Yin">Yin</option><option value="å°å·«">å°å·«</option><option value="Peter">Peter</option><option value="manual">æ‰‹å‹•è¼¸å…¥...</option>
                </select>
            </div>
            <div class="flex-1 text-right flex justify-end gap-2 no-print">
                <button onclick="saveAndRefresh()" class="bg-amber-500 text-white px-3 py-1.5 rounded text-xs shadow font-bold hover:bg-amber-600">ğŸ’¾ æ›´æ–°ä¸¦å„²å­˜</button>
                <button onclick="exportToPDF()" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs shadow font-bold hover:bg-indigo-700">ğŸ“„ PDF & LINE åˆ†äº«</button>
                <button onclick="clearStorage()" class="text-gray-400 text-[10px] hover:underline">æ¸…é™¤æš«å­˜</button>
            </div>
        </div>

        <div class="bg-white p-2 shadow-lg border mb-6">
            <table id="rundownTable" class="rundown-table">
                <thead>
                    <tr class="bg-gray-header text-xs">
                        <th class="col-time">æ™‚é–“</th><th class="col-len">é•·åº¦</th><th class="col-unit">å–®å…ƒ</th><th class="col-desc">å·¥ä½œèªªæ˜</th><th class="col-job">åˆ†å·¥</th><th class="col-staff">äººå“¡</th>
                    </tr>
                </thead>
                <tbody id="rundownBody"></tbody>
            </table>
            <button onclick="addRow()" class="mt-2 bg-green-600 text-white px-4 py-1 rounded font-bold text-xs no-print shadow hover:bg-green-700">+ å¢åŠ ä¸€è¡Œ</button>
        </div>

        <div class="bg-white p-4 shadow-lg border">
            <div class="flex items-center mb-2 border-l-4 border-blue-600 pl-2">
                <h3 class="font-black text-lg">å™¨ææ¸…å–®æ ¸å° (å¯æ‹–æ›³æ’åº)</h3>
            </div>
            <table class="item-table text-xs">
                <thead>
                    <tr class="bg-gray-800 text-white text-center">
                        <th class="w-1/2 py-2">æœå‹™å°ç›¸é—œ</th><th class="w-1/2 py-2">èˆå°ç›¸é—œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div id="serviceDeskItems" class="sortable-list"></div>
                            <span class="add-item-btn no-print" onclick="addManualItem('serviceDeskItems')">+ å¢åŠ æœå‹™å°é …ç›®</span>
                        </td>
                        <td>
                            <div id="stageItems" class="sortable-list"></div>
                            <span class="add-item-btn no-print" onclick="addManualItem('stageItems')">+ å¢åŠ èˆå°é …ç›®</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const staffs = ["éµä»", "æŸç·¯", "æ±Ÿå“¥", "ç‘©é©Š", "éœ²æ¯”", "èŠ³ç‘œ", "å´§ç‘‹", "å·¥è®€1", "å·¥è®€2"];
        const jobs = ["æ§å ´", "éŸ³éŸ¿", "ä¸»æŒäºº", "émic", "ä¸Šæ‰‹æ¿", "ä¸Šé“å…·", "æ”å½±", "æœå‹™å°"];
        let jobMapping = {}; // è¨˜æ†¶åˆ†å·¥èˆ‡äººå“¡çš„é…å°

        window.onload = function() {
            if (!loadData()) { // è‹¥ç„¡æš«å­˜å‰‡åˆå§‹åŒ–
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('eventDate').value = today;
                for (let i = 0; i < 7; i++) addRow(i === 0);
                renderDefaultChecklists();
            }
            updateDayOfWeek();
            calculateAllTimes();
            initSortable();
        };

        // --- æ ¸å¿ƒï¼šå„²å­˜èˆ‡è¼‰å…¥åŠŸèƒ½ ---
        function saveAndRefresh() {
            calculateAllTimes();
            const data = {
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                host: document.getElementById('headerHost').value,
                jobMapping: jobMapping,
                rundown: [],
                serviceItems: getListItems('serviceDeskItems'),
                stageItems: getListItems('stageItems')
            };

            document.querySelectorAll("#rundownBody tr").forEach(row => {
                const jobSels = Array.from(row.querySelectorAll(".job-s")).map(s => s.value);
                const staffSels = Array.from(row.querySelectorAll(".staff-s")).map(s => s.value);
                data.rundown.push({
                    startTime: row.querySelector(".start-time")?.value || "",
                    duration: row.querySelector(".duration").value,
                    unit: row.querySelector(".col-unit div").innerText,
                    desc: row.querySelector(".col-desc div").innerText,
                    jobs: jobSels,
                    staffs: staffSels
                });
            });

            localStorage.setItem('rundown_save', JSON.stringify(data));
            alert("è³‡æ–™å·²æ›´æ–°ä¸¦è‡ªå‹•å„²å­˜è‡³ç€è¦½å™¨ï¼");
        }

        function loadData() {
            const saved = localStorage.getItem('rundown_save');
            if (!saved) return false;
            const data = JSON.parse(saved);
            
            document.getElementById('eventTitle').value = data.title;
            document.getElementById('eventDate').value = data.date;
            document.getElementById('headerHost').value = data.host;
            jobMapping = data.jobMapping || {};

            const tbody = document.getElementById("rundownBody");
            tbody.innerHTML = "";
            data.rundown.forEach((item, idx) => addRow(idx === 0, item));
            
            renderChecklistFromData('serviceDeskItems', data.serviceItems);
            renderChecklistFromData('stageItems', data.stageItems);
            return true;
        }

        function getListItems(id) {
            return Array.from(document.getElementById(id).querySelectorAll(".checkbox-item")).map(el => ({
                n: el.querySelector("span[contenteditable]").innerText,
                checked: el.querySelector("input[type='checkbox']").checked,
                q: el.querySelector(".num-input")?.value || ""
            }));
        }

        // --- æ ¸å¿ƒï¼šæ™ºæ…§é€£å‹•é‚è¼¯ ---
        function handleJobChange(select, index) {
            const row = select.closest("tr");
            const staffSelect = row.querySelectorAll(".staff-s")[index];
            const selectedJob = select.value;
            const currentHost = document.getElementById("headerHost").value;

            if (selectedJob === "ä¸»æŒäºº") {
                ensureOption(staffSelect, currentHost);
                staffSelect.value = currentHost;
            } else if (selectedJob !== "" && jobMapping[selectedJob]) {
                const autoStaff = jobMapping[selectedJob];
                ensureOption(staffSelect, autoStaff);
                staffSelect.value = autoStaff;
            }
            checkManual(select);
            initSelectVisibility(row);
        }

        function handleStaffChange(select, index) {
            const row = select.closest("tr");
            const jobSelect = row.querySelectorAll(".job-s")[index];
            if (jobSelect.value && jobSelect.value !== "manual" && select.value && select.value !== "manual") {
                jobMapping[jobSelect.value] = select.value; // å­¸ç¿’é…å°
            }
            checkManual(select);
        }

        function ensureOption(select, val) {
            if (![...select.options].some(opt => opt.value === val)) {
                select.add(new Option(val, val), 0);
            }
        }

        // --- å…¶é¤˜è¡¨æ ¼æ“ä½œåŠŸèƒ½ ---
        function addRow(isFirst = false, savedItem = null) {
            const tbody = document.getElementById("rundownBody");
            const tr = document.createElement("tr");
            
            let timeHTML = isFirst 
                ? `<div class="flex flex-col items-center"><input type="time" class="start-time text-xs font-bold w-full text-center" value="${savedItem?.startTime || '09:00'}" oninput="calculateAllTimes()"><span id="endTime0" class="text-[10px] text-blue-500 font-bold"></span></div>`
                : `<span class="time-display text-xs">--:--</span>`;

            let selectsHTML = "";
            for(let i=0; i<5; i++) {
                let jobVal = savedItem?.jobs[i] || "";
                let staffVal = savedItem?.staffs[i] || "";
                selectsHTML += `
                <div class="flex gap-1 mb-1">
                    <select class="job-s no-print flex-1" onchange="handleJobChange(this, ${i})">
                        <option value="">-</option>${jobs.map(j=>`<option value="${j}" ${j===jobVal?'selected':''}>${j}</option>`).join('')}<option value="manual">æ‰‹å‹•</option>
                    </select>
                    <select class="staff-s no-print flex-1" onchange="handleStaffChange(this, ${i})">
                        <option value="">-</option>${staffs.map(s=>`<option value="${s}" ${s===staffVal?'selected':''}>${s}</option>`).join('')}<option value="manual">æ‰‹å‹•</option>
                    </select>
                </div>`;
            }

            tr.innerHTML = `
                <td class="col-time">${timeHTML}</td>
                <td class="col-len"><input type="number" class="duration text-center w-full text-xs font-bold" value="${savedItem?.duration || 10}" oninput="calculateAllTimes()"></td>
                <td class="col-unit"><div contenteditable="true" class="auto-height-cell font-bold text-blue-900">${savedItem?.unit || 'å–®å…ƒåç¨±'}</div></td>
                <td class="col-desc"><div contenteditable="true" class="auto-height-cell text-gray-600">${savedItem?.desc || 'å·¥ä½œèªªæ˜...'}</div></td>
                <td colspan="2" class="p-1">${selectsHTML}</td>
                <span class="del-btn no-print" onclick="deleteRow(this)">âœ•</span>`;
            
            tbody.appendChild(tr);
            initSelectVisibility(tr);
        }

        function renderDefaultChecklists() {
            const sItems = [{n:"æœå‹™å°ç®±", q:0}, {n:"ç°½åˆ°è¡¨", q:0}, {n:"è²´è³“åå–®", q:0}, {n:"é¤ç›’", q:1}, {n:"ç“¶æ°´", q:1}];
            const stItems = [{n:"TRUSSçµæ§‹", q:0}, {n:"æ–œæ’", q:1}, {n:"æ²™åŒ…", q:1}, {n:"éŸ³éŸ¿çµ„", q:0}];
            renderChecklistFromData('serviceDeskItems', sItems);
            renderChecklistFromData('stageItems', stItems);
        }

        function renderChecklistFromData(id, items) {
            const container = document.getElementById(id);
            container.innerHTML = items.map(item => `
                <div class="checkbox-item">
                    <span class="text-gray-300">â˜°</span>
                    <input type="checkbox" ${item.checked?'checked':''}> 
                    <span contenteditable="true" class="flex-1">${item.n}</span>
                    <input type="number" class="num-input" value="${item.q || ''}" placeholder="0">
                </div>`).join('');
        }

        function calculateAllTimes() {
            const rows = document.querySelectorAll("#rundownBody tr");
            let nextStart = "";
            rows.forEach((row, i) => {
                const duration = parseInt(row.querySelector(".duration").value) || 0;
                let startStr = (i === 0) ? row.querySelector(".start-time").value : nextStart;
                if (startStr) {
                    let [h, m] = startStr.split(":").map(Number);
                    let endM = m + duration;
                    let endH = (h + Math.floor(endM/60)) % 24;
                    endM %= 60;
                    const endStr = `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
                    if (i === 0) document.getElementById("endTime0").innerText = `${startStr}-${endStr}`;
                    else row.querySelector(".time-display").innerText = `${startStr}-${endStr}`;
                    nextStart = endStr;
                }
            });
        }

        function exportToPDF() {
            saveAndRefresh();
            const element = document.getElementById('capture-area');
            html2pdf().set({ margin: 5, filename: 'Rundown.pdf', jsPDF: { format: 'a3', orientation: 'landscape' } }).from(element).save().then(() => {
                window.open(`https://line.me/R/msg/text/?å·²æ›´æ–°æµç¨‹è¡¨ï¼Œè«‹æŸ¥æ”¶ PDFï¼`, '_blank');
            });
        }

        function initSortable() {
            Sortable.create(document.getElementById('serviceDeskItems'), { animation: 150, handle: '.checkbox-item' });
            Sortable.create(document.getElementById('stageItems'), { animation: 150, handle: '.checkbox-item' });
        }

        function syncHostName() {
            const currentHost = document.getElementById("headerHost").value;
            document.querySelectorAll("#rundownBody tr").forEach(row => {
                const jobSels = row.querySelectorAll(".job-s");
                const staffSels = row.querySelectorAll(".staff-s");
                jobSels.forEach((jobSel, i) => { if (jobSel.value === "ä¸»æŒäºº") { ensureOption(staffSels[i], currentHost); staffSels[i].value = currentHost; } });
            });
        }

        function initSelectVisibility(row) {
            const jobSels = row.querySelectorAll('.job-s');
            jobSels.forEach((sel, i) => { if (i > 0) sel.parentElement.style.display = (jobSels[i-1].value !== "") ? 'flex' : 'none'; });
        }

        function checkManual(sel) {
            if (sel.value === "manual") {
                const v = prompt("è«‹è¼¸å…¥è‡ªå®šç¾©å…§å®¹ï¼š");
                if (v) { ensureOption(sel, v); sel.value = v; sel.dispatchEvent(new Event('change')); }
                else { sel.selectedIndex = 0; }
            }
        }

        function updateDayOfWeek() {
            const d = new Date(document.getElementById('eventDate').value);
            if (!isNaN(d.getTime())) document.getElementById('dayOfWeek').innerText = `(é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`;
        }

        function deleteRow(btn) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { btn.closest("tr").remove(); calculateAllTimes(); } }
        function clearStorage() { if(confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰æš«å­˜è³‡æ–™ä¸¦é‡ç½®ï¼Ÿ")) { localStorage.removeItem('rundown_save'); location.reload(); } }
        function addManualItem(id) {
            const container = document.getElementById(id);
            const div = document.createElement('div');
            div.className = 'checkbox-item';
            div.innerHTML = `<span class="text-gray-300">â˜°</span><input type="checkbox"> <span contenteditable="true" class="flex-1">æ–°é …ç›®</span> <input type="number" class="num-input" placeholder="0">`;
            container.appendChild(div);
        }
    </script>
</body>
</html>
