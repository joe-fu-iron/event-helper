<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 é›²ç«¯å°ˆæ¥­åŸ·è¡Œå¤§è¡¨ - æœ€çµ‚æ•´åˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f8fafc; font-size: 13px; }
        .rundown-table, .item-table { width: 100%; border-collapse: collapse; border: 2px solid black; background: white; }
        .rundown-table th, .rundown-table td, .item-table th, .item-table td { border: 1.2px solid black; padding: 6px; vertical-align: top; position: relative; }
        .bg-gray-header { background-color: #f3f4f6; }
        .input-line { border: none; border-bottom: 1px solid black; outline: none; background: transparent; }
        .auto-height-cell { min-height: 40px; white-space: pre-wrap; word-break: break-all; outline: none; }
        .select-container { display: flex; flex-direction: column; gap: 2px; }
        select { background: #f9fafb; outline: none; width: 100%; cursor: pointer; font-size: 11px; border: 1px solid #ddd; border-radius: 2px; }
        
        .col-time { width: 100px; text-align: center; }
        .col-len { width: 55px; text-align: center; }
        .col-unit { width: 150px; } 
        .col-desc { width: 150px; } 
        .col-job, .col-staff { width: 75px; } 
        
        .del-btn { position: absolute; right: -25px; top: 15px; color: #ccc; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 16px; }
        tr:hover .del-btn { color: #ef4444; }
        
        .checkbox-item { display: flex; align-items: center; padding: 4px 8px; font-size: 12px; gap: 8px; background: white; border: 1px solid transparent; cursor: grab; }
        .checkbox-item:hover { background: #f1f5f9; border-color: #cbd5e1; border-radius: 4px; }
        .sortable-ghost { opacity: 0.4; background: #dbeafe; }
        
        .time-display { font-family: 'Courier New', monospace; font-weight: bold; color: #1d4ed8; text-align: center; display: block; }
        .num-input { width: 45px; border: 1px solid #ccc; border-radius: 3px; padding: 1px 2px; text-align: center; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; font-weight: bold; }

        @media print { .no-print { display: none !important; } .del-btn { display: none !important; } body { padding: 0; } }
    </style>
</head>
<body class="p-2 pr-10">

    <div id="loading" class="loading-overlay">â˜ï¸ é›²ç«¯è³‡æ–™åŒæ­¥ä¸­...</div>

    <div id="capture-area" class="max-w-[1580px] mx-auto">
        <div class="bg-white p-4 rounded shadow border mb-3 flex flex-wrap gap-4 font-bold text-sm items-center">
            <div>ä¸»é¡Œï¼š<input type="text" id="eventTitle" class="input-line w-48" placeholder="è«‹è¼¸å…¥æ´»å‹•åç¨±"></div>
            <div>æ—¥æœŸï¼š<input type="date" id="eventDate" class="input-line" onchange="updateDayOfWeek()"> <span id="dayOfWeek" class="text-blue-600"></span></div>
            <div>ä¸»æŒäººï¼š
                <select id="headerHost" class="input-line w-28 border-b border-black font-bold" onchange="syncHostName()">
                    <option value="Yin">Yin</option><option value="å°å·«">å°å·«</option><option value="Peter">Peter</option><option value="manual">æ‰‹å‹•è¼¸å…¥...</option>
                </select>
            </div>
            <div class="flex-1 text-right flex justify-end gap-2 no-print">
                <button onclick="syncToCloud()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs shadow font-bold hover:bg-blue-700">ğŸ’¾ æ›´æ–°ä¸¦å„²å­˜é›²ç«¯</button>
                <button onclick="exportToPDF()" class="bg-amber-500 text-white px-3 py-1.5 rounded text-xs shadow font-bold hover:bg-amber-600">ğŸ“„ PDF & LINE åˆ†äº«</button>
                <button onclick="clearStorage()" class="text-gray-400 text-[10px] hover:underline">é‡ç½®è¡¨æ ¼</button>
            </div>
        </div>

        <div class="bg-white p-2 shadow-lg border mb-6">
            <table id="rundownTable" class="rundown-table">
                <thead>
                    <tr class="bg-gray-header text-xs text-center">
                        <th class="col-time">æ™‚é–“</th><th class="col-len">é•·åº¦</th><th class="col-unit">å–®å…ƒ</th><th class="col-desc">å·¥ä½œèªªæ˜</th><th colspan="2">åˆ†å·¥èˆ‡äººå“¡ (è‡ªå‹•é€£å‹•)</th>
                    </tr>
                </thead>
                <tbody id="rundownBody"></tbody>
            </table>
            <button onclick="addRow()" class="mt-2 bg-green-600 text-white px-4 py-1 rounded font-bold text-xs no-print shadow hover:bg-green-700">+ å¢åŠ ä¸€è¡Œ</button>
        </div>

        <div class="bg-white p-4 shadow-lg border">
            <h3 class="font-black text-lg mb-2 border-l-4 border-blue-600 pl-2">å™¨ææ¸…å–®æ ¸å° (å¯æ‹–æ›³æ’åº)</h3>
            <table class="item-table text-xs">
                <thead><tr class="bg-gray-800 text-white text-center"><th class="w-1/2 py-2">æœå‹™å°ç›¸é—œ</th><th class="w-1/2 py-2">èˆå°ç›¸é—œ</th></tr></thead>
                <tbody>
                    <tr>
                        <td>
                            <div id="serviceDeskItems"></div>
                            <span class="text-blue-500 text-[10px] cursor-pointer no-print p-2 inline-block" onclick="addManualItem('serviceDeskItems')">+ å¢åŠ é …ç›®</span>
                        </td>
                        <td>
                            <div id="stageItems"></div>
                            <span class="text-blue-500 text-[10px] cursor-pointer no-print p-2 inline-block" onclick="addManualItem('stageItems')">+ å¢åŠ é …ç›®</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwBs_9uUdH6ac1z28wX6nIidT2xjqey6X_zm6PAoaLOyw4mMvNbwXlmr8Q-Z3pRd985/exec";
        const staffs = ["éµä»", "æŸç·¯", "æ±Ÿå“¥", "ç‘©é©Š", "éœ²æ¯”", "èŠ³ç‘œ", "å´§ç‘‹", "å·¥è®€1", "å·¥è®€2"];
        const jobs = ["æ§å ´", "éŸ³éŸ¿", "ä¸»æŒäºº", "émic", "ä¸Šæ‰‹æ¿", "ä¸Šé“å…·", "æ”å½±", "æœå‹™å°"];
        let jobMapping = {};

        window.onload = () => loadFromCloud();

        // æ ¸å¿ƒï¼šé›²ç«¯å„²å­˜
        async function syncToCloud() {
            showLoading(true);
            calculateAllTimes();
            const data = {
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                host: document.getElementById('headerHost').value,
                jobMapping: jobMapping,
                rundown: [],
                serviceItems: getListItems('serviceDeskItems'),
                stageItems: getListItems('stageItems')
            };

            document.querySelectorAll("#rundownBody tr").forEach(row => {
                data.rundown.push({
                    startTime: row.querySelector(".start-time")?.value || "",
                    duration: row.querySelector(".duration").value,
                    unit: row.querySelector(".col-unit div").innerText,
                    desc: row.querySelector(".col-desc div").innerText,
                    jobs: Array.from(row.querySelectorAll(".job-s")).map(s => s.value),
                    staffs: Array.from(row.querySelectorAll(".staff-s")).map(s => s.value)
                });
            });

            try {
                await fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) });
                localStorage.setItem('rundown_local', JSON.stringify(data));
                alert("âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼");
            } catch (e) { alert("âŒ åŒæ­¥å¤±æ•—ï¼Œåƒ…å„²å­˜è‡³æœ¬æ©Ÿã€‚"); }
            showLoading(false);
        }

        // æ ¸å¿ƒï¼šè¼‰å…¥ (å„ªå…ˆé›²ç«¯ï¼Œè‹¥ç„¡å‰‡åˆå§‹åŒ– 7 è¡Œ)
        async function loadFromCloud() {
            showLoading(true);
            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                if (data && data.rundown && data.rundown.length > 0) {
                    renderPage(data);
                } else {
                    initDefault();
                }
            } catch (e) {
                const local = localStorage.getItem('rundown_local');
                local ? renderPage(JSON.parse(local)) : initDefault();
            }
            showLoading(false);
        }

        function initDefault() {
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
            for (let i = 0; i < 7; i++) addRow(i === 0);
            renderChecklist('serviceDeskItems', [{n:"æœå‹™å°ç®±", q:1}, {n:"ç°½åˆ°è¡¨", q:2}, {n:"é¤ç›’", q:0}, {n:"ç“¶æ°´", q:0}]);
            renderChecklist('stageItems', [{n:"TRUSSçµæ§‹", q:1}, {n:"æ²™åŒ…", q:4}, {n:"ç„¡ç·šéº¥å…‹é¢¨", q:4}]);
            calculateAllTimes();
            updateDayOfWeek();
            initSortable();
        }

        function renderPage(data) {
            document.getElementById('eventTitle').value = data.title || "";
            document.getElementById('eventDate').value = data.date || "";
            document.getElementById('headerHost').value = data.host || "Yin";
            jobMapping = data.jobMapping || {};
            const tbody = document.getElementById("rundownBody");
            tbody.innerHTML = "";
            data.rundown.forEach((item, idx) => addRow(idx === 0, item));
            renderChecklist('serviceDeskItems', data.serviceItems);
            renderChecklist('stageItems', data.stageItems);
            calculateAllTimes();
            updateDayOfWeek();
            initSortable();
        }

        // é€£å‹•é‚è¼¯
        function handleJobChange(select, index) {
            const row = select.closest("tr");
            const staffSelect = row.querySelectorAll(".staff-s")[index];
            if (select.value === "ä¸»æŒäºº") {
                const host = document.getElementById("headerHost").value;
                ensureOption(staffSelect, host); staffSelect.value = host;
            } else if (select.value !== "" && jobMapping[select.value]) {
                ensureOption(staffSelect, jobMapping[select.value]);
                staffSelect.value = jobMapping[select.value];
            }
            if (select.value === "manual") handleManual(select);
            initSelectVisibility(row);
        }

        function handleStaffChange(select, index) {
            const row = select.closest("tr");
            const job = row.querySelectorAll(".job-s")[index].value;
            if (job && job !== "manual" && select.value && select.value !== "manual") jobMapping[job] = select.value;
            if (select.value === "manual") handleManual(select);
        }

        function addRow(isFirst = false, saved = null) {
            const tbody = document.getElementById("rundownBody");
            const tr = document.createElement("tr");
            let selectsHTML = "";
            for(let i=0; i<5; i++) {
                let jV = saved?.jobs[i] || ""; let sV = saved?.staffs[i] || "";
                selectsHTML += `<div class="flex gap-1 mb-1"><select class="job-s no-print flex-1" onchange="handleJobChange(this, ${i})"><option value="">-</option>${jobs.map(j=>`<option value="${j}" ${j===jV?'selected':''}>${j}</option>`).join('')}<option value="manual">æ‰‹å‹•</option></select>
                <select class="staff-s no-print flex-1" onchange="handleStaffChange(this, ${i})"><option value="">-</option>${staffs.map(s=>`<option value="${s}" ${s===sV?'selected':''}>${s}</option>`).join('')}<option value="manual">æ‰‹å‹•</option></select></div>`;
            }
            tr.innerHTML = `<td class="col-time">${isFirst ? `<input type="time" class="start-time font-bold w-full text-center text-xs" value="${saved?.startTime||'09:00'}" oninput="calculateAllTimes()"><span id="endTime0" class="text-[10px] text-blue-500 font-bold block text-center"></span>` : '<span class="time-display text-xs"></span>'}</td>
                <td class="col-len"><input type="number" class="duration text-center w-full font-bold text-xs" value="${saved?.duration||10}" oninput="calculateAllTimes()"></td>
                <td class="col-unit"><div contenteditable="true" class="auto-height-cell font-bold text-blue-900 text-center">${saved?.unit||'å–®å…ƒ'}</div></td>
                <td class="col-desc"><div contenteditable="true" class="auto-height-cell text-gray-600">${saved?.desc||'å·¥ä½œèªªæ˜'}</div></td>
                <td colspan="2" class="p-1">${selectsHTML}</td><span class="del-btn no-print" onclick="if(confirm('åˆªé™¤ï¼Ÿ')){this.closest('tr').remove();calculateAllTimes();}">âœ•</span>`;
            tbody.appendChild(tr);
            initSelectVisibility(tr);
        }

        function calculateAllTimes() {
            const rows = document.querySelectorAll("#rundownBody tr");
            let next = "";
            rows.forEach((row, i) =>
